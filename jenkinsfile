node('master'){

    stage('Checkout') {
        echo 'checkout repository'
        checkout scm

        echo 'restore NuGet Packages'
        bat 'nuget.exe restore RabbitChat.sln'
    }
    stage ('CreateAndConfigureWebApp') {
        echo 'Call Powershell'
        def msg = powershell(returnStdout: true, script: 'C:\\scripts\\ps_test.ps1')
        echo msg
    }
    stage('Build') {
        echo 'MsBuild'
        bat "msbuild.exe RabbitChat.Client.Wpf/RabbitChat.Client.Wpf.csproj /p:PublishProfile=release /p:TargetFrameworkVersion=v4.6.1 /p:DeployOnBuild=true"
    }
    stage('PostBuild') {
        echo 'Send Mail'
    }
    post {
        failure {
            script {
                currentBuild.result = 'FAILURE'
            }
        }

        always {
            step([$class: 'Mailer',
                notifyEveryUnstableBuild: true,
                recipients: "martin.poepel@5minds.de",
                sendToIndividuals: true])
        }
    }
}